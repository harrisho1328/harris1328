<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="ç—›é¢¨è¨ˆç®—æ©Ÿ">
<title>ç—›é¢¨è¨ˆç®—æ©Ÿ</title>
<style>
    :root {
        --safe: #34C759;
        --warn: #FFCC00;
        --danger: #FF3B30;
        --bg: #F2F2F7;
        --card: #FFFFFF;
        --blue: #007AFF;
        --text-main: #1C1C1E;
        --text-sub: #8E8E93;
    }
    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        background-color: var(--bg);
        margin: 0;
        padding: 0;
        height: 100vh;
        display: flex;
        flex-direction: column;
        -webkit-tap-highlight-color: transparent;
        color: var(--text-main);
    }
    
    /* é ‚éƒ¨å„€è¡¨æ¿ */
    .dashboard {
        background: white;
        padding: 15px 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        position: sticky;
        top: 0;
        z-index: 50;
    }
    .dashboard-header {
        display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;
    }
    .total-display { font-size: 24px; font-weight: 800; color: #333; }
    .limit-label { font-size: 12px; color: var(--text-sub); }
    
    /* é€²åº¦æ¢ */
    .progress-track {
        height: 12px; background: #E5E5EA; border-radius: 6px; overflow: hidden; position: relative;
    }
    .progress-fill {
        height: 100%; width: 0%; transition: width 0.5s, background-color 0.5s, opacity 0.3s;
    }
    .marker-line {
        position: absolute; top:0; bottom:0; width: 2px; background: #fff; z-index: 2;
    }
    
    /* ç‹€æ…‹æ–‡å­—å€ */
    .status-area {
        text-align: center; margin-top: 8px; font-size: 13px; font-weight: bold; min-height: 20px;
    }

    /* é é¢å®¹å™¨ */
    .page-container {
        flex: 1;
        overflow-y: auto;
        padding: 15px;
        padding-bottom: 110px; /* é¿é–‹åº•éƒ¨å°èˆª */
        display: none;
    }
    .page-container.active { display: block; }

    /* æœå°‹èˆ‡éæ¿¾ */
    .controls { padding: 0 5px 10px 5px; }
    input[type="text"] {
        width: 100%; padding: 12px; font-size: 16px; border: none; border-radius: 12px; background: #E5E5EA; outline: none; box-sizing: border-box;
    }
    
    /* æ©«å‘æ»¾å‹•æ¨™ç±¤åˆ— */
    .tag-scroll-area {
        display: flex;
        gap: 8px;
        overflow-x: auto;
        padding: 5px 2px 15px 2px;
        margin-bottom: 5px;
        -webkit-overflow-scrolling: touch;
    }
    .tag-scroll-area::-webkit-scrollbar { display: none; }

    .tag-btn {
        padding: 6px 14px;
        border-radius: 20px;
        border: 1px solid #ddd;
        background: white;
        color: #666;
        font-size: 13px;
        font-weight: 500;
        white-space: nowrap;
        cursor: pointer;
        transition: all 0.2s;
    }
    .tag-btn.active {
        background: var(--blue);
        color: white;
        border-color: var(--blue);
        font-weight: 600;
        box-shadow: 0 2px 6px rgba(0,122,255,0.3);
    }

    .filter-btn-group { display: flex; gap: 8px; margin-top: 10px; overflow-x: auto; padding-bottom: 5px; }
    .filter-btn {
        padding: 6px 12px; border-radius: 15px; border: none; font-size: 13px; font-weight: 600; cursor: pointer; opacity: 0.6; color: white; white-space: nowrap; flex-shrink: 0;
    }
    .filter-btn.active { opacity: 1; transform: scale(1.05); }

    /* é£Ÿç‰©å¡ç‰‡åˆ—è¡¨ */
    #foodList, #plateList {
        display: grid; grid-template-columns: 1fr; gap: 10px; padding: 0 5px;
    }
    .food-card {
        background: var(--card);
        border-radius: 12px;
        padding: 12px 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .food-info { display: flex; flex-direction: column; }
    .food-name { font-size: 16px; font-weight: 600; margin-bottom: 4px; }
    .food-meta { font-size: 12px; color: var(--text-sub); display: flex; align-items: center; gap: 8px; }
    
    /* ç‡ˆè™Ÿ Badge */
    .badge { padding: 2px 6px; border-radius: 4px; color: white; font-weight: bold; font-size: 10px; }
    .bg-green { background-color: var(--safe); }
    .bg-yellow { background-color: var(--warn); color: black; }
    .bg-red { background-color: var(--danger); }
    
    /* v7.5 æ–°å¢ï¼šé›™æŒ‰éˆ•ç¾¤çµ„ (åŠä»½/å…¨ä»½) */
    .action-group {
        display: flex;
        gap: 5px;
    }
    .action-btn {
        background: #F2F2F7; 
        color: var(--blue); 
        border: 1px solid #E5E5EA; 
        padding: 6px 10px; 
        border-radius: 8px; 
        font-size: 12px; 
        font-weight: 600; 
        cursor: pointer;
        min-width: 40px;
    }
    .action-btn:active { background: #d1d1d6; }
    .action-btn.half { color: #666; font-size: 11px; }

    .remove-btn {
        color: var(--danger); background: none; border: 1px solid var(--danger); padding: 4px 10px; border-radius: 6px; font-size: 12px; cursor: pointer;
    }
    .clear-btn {
        font-size: 13px; color: #888; border: 1px solid #ddd; padding: 4px 10px; border-radius: 6px; background: none; cursor: pointer;
    }

    /* åº•éƒ¨å°èˆª */
    .bottom-nav {
        position: fixed; bottom: 0; width: 100%; background: rgba(255,255,255,0.95);
        border-top: 1px solid #ddd; display: flex; justify-content: space-around; padding: 10px 0;
        backdrop-filter: blur(10px); z-index: 100; padding-bottom: max(10px, env(safe-area-inset-bottom));
    }
    .nav-item { display: flex; flex-direction: column; align-items: center; color: #8E8E93; font-size: 10px; border: none; background: none; cursor: pointer; width: 50%; }
    .nav-item.active { color: var(--blue); }
    .nav-icon { font-size: 24px; margin-bottom: 2px; }

    /* æ‡¸æµ®æ–°å¢æŒ‰éˆ• (FAB) */
    .fab {
        position: fixed; bottom: 100px; right: 20px; background: var(--blue); color: white; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; border: none; box-shadow: 0 4px 10px rgba(0,122,255,0.3); z-index: 90; cursor: pointer;
    }

    /* æç¤ºèˆ‡è¦–çª— */
    #toast {
        visibility: hidden; min-width: 200px; background-color: #333; color: #fff; text-align: center; border-radius: 50px; padding: 10px; position: fixed; z-index: 300; left: 50%; bottom: 90px; transform: translateX(-50%); font-size: 14px; opacity: 0; transition: opacity 0.3s;
    }
    #toast.show { visibility: visible; opacity: 0.9; bottom: 100px; }

    .modal-overlay {
        display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 200; align-items: center; justify-content: center;
    }
    .modal-content {
        background: white; padding: 20px; border-radius: 20px; width: 80%; max-width: 300px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }
</style>
</head>
<body>

    <div class="dashboard">
        <div class="dashboard-header">
            <div>
                <div class="limit-label">æœ¬é¤æ™®æ— (ç›®æ¨™ <200)</div>
                <div class="total-display"><span id="totalPurine">0</span> <span style="font-size:14px; color:#666;">mg</span></div>
            </div>
            <button class="clear-btn" onclick="clearPlate()">ğŸ—‘ï¸ é‡ç½®</button>
        </div>
        <div class="progress-track">
            <div id="progressFill" class="progress-fill" style="width: 0%;"></div>
            <div class="marker-line" style="left: 37.5%;"></div> </div>
        <div style="display:flex; justify-content:space-between; margin-top:4px; font-size:10px; color:#999;">
            <span>0</span>
            <span style="margin-left:-10px;">200 (å–®é¤)</span>
            <span>400 (å…¨æ—¥)</span>
        </div>
        <div id="statusText" class="status-area" style="color:var(--safe);">âœ… æº–å‚™é–‹å§‹</div>
    </div>

    <div id="searchPage" class="page-container active">
        <div class="controls">
            <input type="text" id="searchInput" placeholder="æœå°‹é£Ÿç‰© (ä¾‹: èŠ¥è˜­, ç‰›æ’)..." onkeyup="filterFood()">
            
            <div id="tagFilters" class="tag-scroll-area"></div>

            <div class="filter-btn-group">
                <button class="filter-btn bg-green" onclick="filterByColor('green')">ğŸŸ¢ æ”¾å¿ƒ</button>
                <button class="filter-btn bg-yellow" onclick="filterByColor('yellow')">ğŸŸ¡ é©é‡</button>
                <button class="filter-btn bg-red" onclick="filterByColor('red')">ğŸ”´ å°å¿ƒ</button>
                <button class="filter-btn" style="background:#8E8E93" onclick="filterByColor('all')">å…¨éƒ¨</button>
            </div>
        </div>
        <div id="foodList"></div>
    </div>

    <div id="platePage" class="page-container">
        <h2 style="padding:0 15px; font-size:18px; color:#333;">ğŸ½ï¸ é€™ä¸€é¤åƒäº†...</h2>
        <div id="plateList"></div>
    </div>

    <button class="fab" onclick="openCustomModal()">+</button>

    <nav class="bottom-nav">
        <button class="nav-item active" onclick="switchTab('search')" id="tab-search">
            <div class="nav-icon">ğŸ”</div>
            <div>æ‰¾é£Ÿç‰©</div>
        </button>
        <button class="nav-item" onclick="switchTab('plate')" id="tab-plate">
            <div class="nav-icon">ğŸ“Š</div>
            <div>çœ‹çµæœ</div>
        </button>
    </nav>

    <div id="toast">å·²åŠ å…¥ï¼</div>
    
    <div id="customModal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="margin-top:0; text-align:center;">æ–°å¢è‡ªè¨‚é£Ÿç‰©</h3>
            <input type="text" id="newFoodName" placeholder="åç¨± (ä¾‹: ä¹¾éºµ)" style="width:100%; padding:10px; margin-bottom:10px; box-sizing:border-box; border:1px solid #ddd; border-radius:8px;">
            <input type="number" id="newFoodPurine" placeholder="æ™®æ—å€¼ (mg/100g)" style="width:100%; padding:10px; margin-bottom:10px; box-sizing:border-box; border:1px solid #ddd; border-radius:8px;">
            <p style="font-size:12px; color:#888; margin:0 0 10px 0;">*å¦‚æœä¸ç¢ºå®šï¼Œè«‹ä¼°ç®—é¡è‰²å³å¯</p>
            <select id="newFoodLevel" style="width:100%; padding:10px; margin-bottom:20px; border-radius:8px;">
                <option value="0">ğŸŸ¢ ç¶ ç‡ˆ (0-50mg)</option>
                <option value="1">ğŸŸ¡ é»ƒç‡ˆ (50-150mg)</option>
                <option value="2">ğŸ”´ ç´…ç‡ˆ (>150mg)</option>
            </select>
            <div style="display:flex; gap:10px;">
                <button onclick="closeCustomModal()" style="flex:1; padding:10px; border:none; background:#E5E5EA; border-radius:8px;">å–æ¶ˆ</button>
                <button onclick="saveNewFood()" style="flex:1; padding:10px; background:var(--blue); color:white; border:none; border-radius:8px;">å„²å­˜</button>
            </div>
        </div>
    </div>

<script>
    // ğŸŒŸ v7.3 å®Œæ•´è³‡æ–™åº« (å«æ¨™ç±¤åˆ†é¡)
    const defaultDB = [
        // --- ğŸŸ¢ ç¶ ç‡ˆ ---
        {name: "èœå¿ƒ/èŠ¥è˜­", purine: 25, level: 0, tags: ["è”¬èœ"]},
        {name: "é’ç“œ", purine: 10, level: 0, tags: ["è”¬èœ"]},
        {name: "èŒ„å­", purine: 20, level: 0, tags: ["è”¬èœ"]},
        {name: "ç²Ÿç±³ (Corn)", purine: 30, level: 0, tags: ["è”¬èœ", "ç«é‹"]},
        {name: "å—ç“œ", purine: 25, level: 0, tags: ["è”¬èœ"]},
        {name: "ç”˜ç­/ç´…è˜¿è””", purine: 15, level: 0, tags: ["è”¬èœ", "ç«é‹"]},
        {name: "è¥¿è˜­èŠ±", purine: 70, level: 0, tags: ["è”¬èœ"]},
        {name: "è èœ", purine: 57, level: 0, tags: ["è”¬èœ", "ç«é‹"]},
        
        {name: "é‡‘é‡è‡", purine: 50, level: 0, tags: ["è‡é¡", "ç«é‹"]},
        {name: "é›é«€è‡/æé®‘è‡", purine: 45, level: 0, tags: ["è‡é¡"]},
        {name: "ç™½è˜‘è‡/å¤§å•¡è‡", purine: 30, level: 0, tags: ["è‡é¡"]},
        {name: "é´»å–œè‡ (æœ¬è‡)", purine: 40, level: 0, tags: ["è‡é¡", "ç«é‹"]},
        {name: "éˆèŠè‡", purine: 45, level: 0, tags: ["è‡é¡"]},
        {name: "é»‘æœ¨è€³/é›²è€³", purine: 10, level: 0, tags: ["è‡é¡", "ç«é‹"]},
        {name: "é›ªè€³/ç™½æœ¨è€³", purine: 10, level: 0, tags: ["è‡é¡", "ç”œå“"]},

        {name: "è˜‹æœ", purine: 14, level: 0, tags: ["æ°´æœ"]},
        {name: "é¦™è•‰", purine: 16, level: 0, tags: ["æ°´æœ"]},
        {name: "ç«é¾æœ", purine: 20, level: 0, tags: ["æ°´æœ"]},
        {name: "è¥¿ç“œ", purine: 10, level: 0, tags: ["æ°´æœ"]},
        {name: "è—è“/å£«å¤šå•¤æ¢¨", purine: 18, level: 0, tags: ["æ°´æœ"]},

        {name: "ç™½é£¯/éºµ", purine: 25, level: 0, tags: ["ä¸»é£Ÿ"]},
        {name: "ç±³ç²‰/ç²‰çµ²", purine: 15, level: 0, tags: ["ä¸»é£Ÿ", "ç«é‹"]},
        {name: "é€šç²‰/æ„ç²‰", purine: 20, level: 0, tags: ["ä¸»é£Ÿ"]},
        {name: "æ–¹åŒ…/é¥…é ­", purine: 20, level: 0, tags: ["ä¸»é£Ÿ", "é…’æ¨“é»å¿ƒ"]},
        {name: "ç•ªèŒ„è›‹é£¯", purine: 50, level: 0, tags: ["ä¸»é£Ÿ"]},

        {name: "é›è›‹", purine: 0, level: 0, tags: ["è›‹å¥¶"]},
        {name: "ç‰›å¥¶", purine: 0, level: 0, tags: ["è›‹å¥¶", "é£²å“"]},
        {name: "è±†è…", purine: 20, level: 0, tags: ["è±†è£½å“", "ç«é‹"]},
        {name: "èŒ¶ç¢—è’¸", purine: 20, level: 0, tags: ["è›‹å¥¶", "æ—¥å¼"]},
        {name: "æµ·åƒ", purine: 8, level: 0, tags: ["æµ·é®®", "é…’æ¨“é»å¿ƒ"]},
        {name: "ä¸‰æ–‡é­šç±½", purine: 20, level: 0, tags: ["æµ·é®®", "æ—¥å¼"]},
        {name: "å¸ƒç”¸/å•«å–±", purine: 8, level: 0, tags: ["ç”œå“"]},

        // --- ğŸŸ¡ é»ƒç‡ˆ ---
        {name: "è¥¿å†·/è‚‰çœ¼ç‰›æ’", purine: 110, level: 1, tags: ["è‚‰é¡", "è¥¿é¤"]},
        {name: "ç‰›è…©", purine: 130, level: 1, tags: ["è‚‰é¡", "ç²‰éºµ"]},
        {name: "å‰åˆ—ç‰›/è±¬ (ç‚¸)", purine: 120, level: 1, tags: ["è‚‰é¡", "æ—¥å¼"]},
        {name: "ç˜¦è±¬è‚‰", purine: 119, level: 1, tags: ["è‚‰é¡"]},
        {name: "é›è…¿è‚‰", purine: 140, level: 1, tags: ["è‚‰é¡"]},
        {name: "é›èƒ¸è‚‰", purine: 137, level: 1, tags: ["è‚‰é¡"]},
        {name: "Parma Ham", purine: 150, level: 1, tags: ["è‚‰é¡", "è¥¿é¤"]},

        {name: "ä¸‰æ–‡é­š", purine: 119, level: 1, tags: ["æµ·é®®", "æ—¥å¼"]},
        {name: "é±ˆé­š", purine: 109, level: 1, tags: ["æµ·é®®"]},
        {name: "é­šå­é†¬", purine: 144, level: 1, tags: ["æµ·é®®", "è¥¿é¤"]},
        {name: "é¾è¦ (è‚‰)", purine: 100, level: 1, tags: ["æµ·é®®", "é…’æ¨“é»å¿ƒ"]},
        {name: "æ³¢å£«é “é¾è¦", purine: 105, level: 1, tags: ["æµ·é®®"]},
        {name: "è™è¦/å¤§è¦", purine: 120, level: 1, tags: ["æµ·é®®", "ç«é‹"]},
        {name: "åŸºåœè¦/ç™½ç¼è¦", purine: 135, level: 1, tags: ["æµ·é®®", "é…’æ¨“é»å¿ƒ"]},
        {name: "çµç¶è¦", purine: 125, level: 1, tags: ["æµ·é®®"]},
        {name: "å°é¾è¦ (è‚‰)", purine: 130, level: 1, tags: ["æµ·é®®"]},

        {name: "æ¸…è’¸çŸ³æ–‘", purine: 115, level: 1, tags: ["æµ·é®®", "é…’æ¨“é»å¿ƒ"]},
        {name: "æ¸…è’¸é±¸é­š", purine: 110, level: 1, tags: ["æµ·é®®", "é…’æ¨“é»å¿ƒ"]},
        {name: "é¯‡é­š/è‰é­š", purine: 110, level: 1, tags: ["æµ·é®®", "ç«é‹"]},
        {name: "å¤§çœ¼é› (æœ¨æ£‰é­š)", purine: 130, level: 1, tags: ["æµ·é®®"]},
        {name: "é¦™ç…é»ƒèŠ±é­š", purine: 125, level: 1, tags: ["æµ·é®®"]},
        {name: "æª¸æª¬çƒé ­", purine: 125, level: 1, tags: ["æµ·é®®", "æ³°å¼"]},
        {name: "ç…å°é¯§é­š", purine: 140, level: 1, tags: ["æµ·é®®"]},
        {name: "æ¯”ç›®é­š/æ‰å£é­š", purine: 120, level: 1, tags: ["æµ·é®®", "æ—¥å¼"]},
        {name: "ç´…è¡«é­š (ç…)", purine: 135, level: 1, tags: ["æµ·é®®"]},

        {name: "å°ç± åŒ…", purine: 100, level: 1, tags: ["é…’æ¨“é»å¿ƒ"]},
        {name: "é³³çˆª", purine: 130, level: 1, tags: ["é…’æ¨“é»å¿ƒ"]},
        {name: "è²¢ä¸¸/ç‰›ä¸¸", purine: 80, level: 1, tags: ["åŠ å·¥é£Ÿå“", "ç«é‹", "ç²‰éºµ"]},
        {name: "è˜†ç­", purine: 55, level: 1, tags: ["è”¬èœ"]},
        {name: "é®®å†¬è‡/é¦™è‡", purine: 60, level: 1, tags: ["è‡é¡", "ç«é‹"]},
        {name: "ç§€çè‡", purine: 90, level: 1, tags: ["è‡é¡", "ç«é‹"]},
        {name: "è‰è‡", purine: 90, level: 1, tags: ["è‡é¡"]},
        {name: "çŒ´é ­è‡", purine: 65, level: 1, tags: ["è‡é¡"]},
        {name: "èˆè‡", purine: 80, level: 1, tags: ["è‡é¡"]},

        {name: "çš®è›‹ç˜¦è‚‰ç²¥", purine: 70, level: 1, tags: ["ä¸»é£Ÿ", "ç²¥å“"]},
        {name: "ç²Ÿç±³è‚‰ç²’é£¯", purine: 80, level: 1, tags: ["ä¸»é£Ÿ"]},
        {name: "èŠ±ç”Ÿ", purine: 79, level: 1, tags: ["é›¶é£Ÿ"]},
        {name: "æä»/æ ¸æ¡ƒ", purine: 35, level: 1, tags: ["é›¶é£Ÿ"]},

        {name: "é®®è¦é¤ƒ", purine: 120, level: 1, tags: ["é…’æ¨“é»å¿ƒ"]},
        {name: "èŸ¹ç±½ç‡’è³£", purine: 130, level: 1, tags: ["é…’æ¨“é»å¿ƒ"]},
        {name: "å±±ç«¹ç‰›è‚‰çƒ", purine: 110, level: 1, tags: ["é…’æ¨“é»å¿ƒ"]},
        {name: "å‰ç‡’åŒ…", purine: 90, level: 1, tags: ["é…’æ¨“é»å¿ƒ"]},
        {name: "è˜¿è””ç³• (ç…)", purine: 70, level: 1, tags: ["é…’æ¨“é»å¿ƒ"]},
        {name: "é¹¹æ°´è§’", purine: 100, level: 1, tags: ["é…’æ¨“é»å¿ƒ"]},
        {name: "é®®è¦è…¸ç²‰", purine: 90, level: 1, tags: ["é…’æ¨“é»å¿ƒ"]},
        {name: "ç‰›è‚‰è…¸ç²‰", purine: 80, level: 1, tags: ["é…’æ¨“é»å¿ƒ"]},
        {name: "çç é›/ç³¯ç±³é›", purine: 120, level: 1, tags: ["é…’æ¨“é»å¿ƒ"]},
        {name: "æ˜¥æ² (ç‚¸)", purine: 110, level: 1, tags: ["é…’æ¨“é»å¿ƒ"]},
        {name: "è±‰æ±è’¸æ’éª¨", purine: 145, level: 1, tags: ["é…’æ¨“é»å¿ƒ", "è‚‰é¡"]},
        
        // --- ğŸ”´ ç´…ç‡ˆ ---
        {name: "å°é­šä¹¾", purine: 1138, level: 2, tags: ["ä¹¾è²¨", "é›¶é£Ÿ"]},
        {name: "é…µæ¯ç²‰", purine: 680, level: 2, tags: ["èª¿å‘³"]},
        {name: "é›ç²¾/æ»´é›ç²¾", purine: 500, level: 2, tags: ["è£œå“"]},
        {name: "è¦ç±³/è¦çš® (ä¹¾)", purine: 1100, level: 2, tags: ["ä¹¾è²¨"]},
        {name: "æ«»èŠ±è¦", purine: 800, level: 2, tags: ["ä¹¾è²¨"]},
        
        {name: "å¤§é–˜èŸ¹è†", purine: 300, level: 2, tags: ["æµ·é®®"]},
        {name: "è±¬è‚", purine: 284, level: 2, tags: ["å…§è‡Ÿ", "ç²‰éºµ"]},
        {name: "è±¬æ½¤éºµ", purine: 280, level: 2, tags: ["å…§è‡Ÿ", "ç²‰éºµ"]},
        {name: "éµè‚", purine: 380, level: 2, tags: ["å…§è‡Ÿ", "è¥¿é¤"]},

        {name: "æ²™ç”¸é­š", purine: 210, level: 2, tags: ["æµ·é®®"]},
        {name: "è ”/é’å£", purine: 180, level: 2, tags: ["æµ·é®®", "ç«é‹"]},
        {name: "é¯–é­š", purine: 165, level: 2, tags: ["æµ·é®®", "æ—¥å¼"]},
        {name: "ç”œè¦ (åˆºèº«)", purine: 170, level: 2, tags: ["æµ·é®®", "æ—¥å¼"]},
        {name: "é¾è¦é ­/è¦è†", purine: 300, level: 2, tags: ["æµ·é®®"]},
        {name: "ç‰¡ä¸¹è¦", purine: 160, level: 2, tags: ["æµ·é®®", "æ—¥å¼"]},

        {name: "ç™½é£¯é­š", purine: 240, level: 2, tags: ["æµ·é®®"]},
        {name: "å¤šæ˜¥é­š", purine: 280, level: 2, tags: ["æµ·é®®", "æ—¥å¼"]},
        {name: "ç§‹åˆ€é­š", purine: 210, level: 2, tags: ["æµ·é®®", "æ—¥å¼"]},
        {name: "é¦¬å‹é­š (é¹¹é­š)", purine: 300, level: 2, tags: ["æµ·é®®", "ä¹¾è²¨"]},
        {name: "ç‡’éµ/é´¨", purine: 165, level: 2, tags: ["è‚‰é¡"]},

        {name: "å†¬è”­åŠŸæ¹¯", purine: 180, level: 2, tags: ["æ¹¯å“", "æ³°å¼"]},
        {name: "è±šéª¨æ‹‰éºµæ¹¯", purine: 160, level: 2, tags: ["æ¹¯å“", "æ—¥å¼"]},
        {name: "è€ç«æ¹¯", purine: 150, level: 2, tags: ["æ¹¯å“", "é…’æ¨“é»å¿ƒ"]},

        {name: "ä¹¾å†¬è‡/ä¹¾é¦™è‡", purine: 380, level: 2, tags: ["ä¹¾è²¨"]},
        {name: "ç‰›è‚èŒ (ä¹¾)", purine: 300, level: 2, tags: ["ä¹¾è²¨"]},
        {name: "å§¬æ¾èŒ¸ (ä¹¾)", purine: 290, level: 2, tags: ["ä¹¾è²¨"]},
        {name: "ä¹¾é»ƒè±†", purine: 172, level: 2, tags: ["ä¹¾è²¨"]},

        {name: "è±‰æ±è’¸é³³çˆª", purine: 160, level: 2, tags: ["é…’æ¨“é»å¿ƒ"]},
        {name: "è±¬æ½¤ç‡’è³£", purine: 280, level: 2, tags: ["é…’æ¨“é»å¿ƒ", "å…§è‡Ÿ"]},
        {name: "é‡‘éŒ¢è‚š/ç‰›æŸè‘‰", purine: 150, level: 2, tags: ["é…’æ¨“é»å¿ƒ", "å…§è‡Ÿ"]},
        {name: "é®®ç«¹å·", purine: 160, level: 2, tags: ["é…’æ¨“é»å¿ƒ"]},
        {name: "çŒæ¹¯é¤ƒ", purine: 180, level: 2, tags: ["é…’æ¨“é»å¿ƒ"]},
        {name: "èŠ‹è§’ (ç‚¸)", purine: 120, level: 2, tags: ["é…’æ¨“é»å¿ƒ"]},
        {name: "XOé†¬ç‚’è…¸ç²‰", purine: 140, level: 2, tags: ["é…’æ¨“é»å¿ƒ"]},

        // --- ğŸš¨ ä»£è¬åœ°é›· ---
        {name: "å•¤é…’ (350ml)", purine: 20, level: 2, isTrigger: true, tags: ["é£²å“", "é…’"]},
        {name: "å¨å£«å¿Œ/ä¼ç‰¹åŠ ", purine: 0, level: 2, isTrigger: true, tags: ["é£²å“", "é…’"]},
        {name: "æ—¥æœ¬ç‡’é…", purine: 0, level: 2, isTrigger: true, tags: ["é£²å“", "é…’"]},
        {name: "éŸ“åœ‹ç‡’é…’", purine: 0, level: 2, isTrigger: true, tags: ["é£²å“", "é…’"]},
        {name: "çç å¥¶èŒ¶", purine: 10, level: 2, isTrigger: true, tags: ["é£²å“"]},
        {name: "å«ç³–æ±½æ°´", purine: 10, level: 2, isTrigger: true, tags: ["é£²å“"]},
    ];

    let allFoods = [];
    let currentFilter = 'all';
    let currentTag = 'all'; 

    // åˆå§‹åŒ–
    function init() {
        allFoods = [...defaultDB];
        allFoods.sort((a, b) => a.level - b.level);
        
        const customData = localStorage.getItem('myGoutFoods_v7');
        if (customData) {
            const customFoods = JSON.parse(customData);
            customFoods.forEach(f => f.isCustom = true);
            allFoods = [...customFoods, ...allFoods];
        }
        
        renderTags(); 
        filterFood();
        renderPlate();
    }

    // æ¸²æŸ“æ¨™ç±¤åˆ—
    function renderTags() {
        const tags = new Set();
        allFoods.forEach(food => {
            if (food.tags) food.tags.forEach(tag => tags.add(tag));
        });
        
        const sortedTags = Array.from(tags).sort((a, b) => {
            if (a === 'é…’æ¨“é»å¿ƒ') return -1;
            if (b === 'é…’æ¨“é»å¿ƒ') return 1;
            return a.localeCompare(b);
        });

        const container = document.getElementById('tagFilters');
        if (!container) return; 
        container.innerHTML = ''; 

        const allBtn = document.createElement('button');
        allBtn.className = `tag-btn ${currentTag === 'all' ? 'active' : ''}`;
        allBtn.innerText = 'å…¨éƒ¨ç¨®é¡';
        allBtn.onclick = () => toggleTag('all');
        container.appendChild(allBtn);

        sortedTags.forEach(tag => {
            const btn = document.createElement('button');
            btn.className = `tag-btn ${currentTag === tag ? 'active' : ''}`;
            btn.innerText = tag;
            btn.onclick = () => toggleTag(tag);
            container.appendChild(btn);
        });
    }

    function toggleTag(tag) {
        currentTag = tag;
        renderTags(); 
        filterFood(); 
    }

    function switchTab(tab) {
        document.querySelectorAll('.page-container').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById(tab + 'Page').classList.add('active');
        document.getElementById('tab-' + tab).classList.add('active');
    }

    // æ¸²æŸ“æœå°‹åˆ—è¡¨ (é¡¯ç¤ºåŠä»½/å…¨ä»½æŒ‰éˆ•)
    function renderList(items) {
        const listContainer = document.getElementById('foodList');
        listContainer.innerHTML = '';
        if (items.length === 0) {
            listContainer.innerHTML = '<div style="text-align:center;color:#999;padding:20px;">æ‰¾ä¸åˆ°...</div>';
            return;
        }
        items.forEach(item => {
            const div = document.createElement('div');
            div.className = 'food-card';
            let badgeClass = '', badgeText = '';
            if(item.level == 0) { badgeClass = 'bg-green'; badgeText = 'ç¶ '; }
            else if(item.level == 1) { badgeClass = 'bg-yellow'; badgeText = 'é»ƒ'; }
            else { badgeClass = 'bg-red'; badgeText = 'ç´…'; }

            const triggerText = item.isTrigger ? 'âš ï¸ ' : '';
            const itemString = encodeURIComponent(JSON.stringify(item));
            
            div.innerHTML = `
                <div class="food-info">
                    <span class="food-name">${triggerText}${item.name} ${item.isCustom ? 'âœï¸':''}</span>
                    <div class="food-meta">
                        <span class="badge ${badgeClass}">${badgeText}</span>
                        <span>ç´„ ${item.purine} mg/100g</span>
                    </div>
                </div>
                <div class="action-group">
                    <button class="action-btn half" onclick="addPortion('${itemString}', 0.5)">åŠä»½</button>
                    <button class="action-btn" onclick="addPortion('${itemString}', 1)">å…¨ä»½</button>
                </div>
            `;
            listContainer.appendChild(div);
        });
    }

    // æ¸²æŸ“é¤ç›¤åˆ—è¡¨
    function renderPlateList(items) {
        const listContainer = document.getElementById('plateList');
        listContainer.innerHTML = '';
        if (items.length === 0) {
            listContainer.innerHTML = '<div style="text-align:center;color:#999;padding:30px;">ç›¤å­ç©ºç©ºçš„...<br>å»åŠ é»å¥½åƒçš„å§ï¼</div>';
            return;
        }
        items.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'food-card';
            const realIndex = items.length - 1 - index; 
            
            const triggerWarning = item.isTrigger ? '<br><span style="color:var(--danger); font-size:11px;">âš ï¸ ä»£è¬é˜»ç¤™ (é…’ç²¾/ç³–)</span>' : '';
            
            // ğŸŒŸ é¡¯ç¤ºå€ç‡é‚è¼¯ï¼š
            // 1. å¦‚æœæ˜¯ 1.0 (å…¨ä»½)ï¼Œä¸é¡¯ç¤º (x1)
            // 2. å¦‚æœæ˜¯ 0.5 (åŠä»½)ï¼Œé¡¯ç¤º (x0.5)
            // 3. å¦‚æœæ˜¯ 2.0 (å…©ä»½)ï¼Œé¡¯ç¤º (x2)
            let portionText = '';
            if (item.portion !== 1) {
                portionText = ` <span style="font-size:13px; color:#007AFF; font-weight:bold;">(x${item.portion})</span>`;
            }

            div.innerHTML = `
                <div class="food-info">
                    <span class="food-name">${item.name}${portionText} ${triggerWarning}</span>
                    <div class="food-meta">
                        <span>+ ${Math.round(item.purine)} mg</span>
                    </div>
                </div>
                <button class="remove-btn" onclick="removeFromPlate(${realIndex})">ç§»é™¤</button>
            `;
            listContainer.appendChild(div);
        });
    }

    function filterFood() {
        const searchText = document.getElementById('searchInput').value.toLowerCase();
        const filtered = allFoods.filter(item => {
            const matchesSearch = item.name.toLowerCase().includes(searchText);
            
            const matchesColor = currentFilter === 'all' ? true :
                currentFilter === 'green' ? item.level == 0 :
                currentFilter === 'yellow' ? item.level == 1 : item.level == 2;
            
            const matchesTag = currentTag === 'all' ? true : (item.tags && item.tags.includes(currentTag));
            
            return matchesSearch && matchesColor && matchesTag;
        });
        renderList(filtered);
    }

    function filterByColor(color) {
        currentFilter = color;
        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        filterFood();
    }

    // ğŸŒŸ æ ¸å¿ƒè¨ˆç®—é‚è¼¯ï¼šç›´æ¥åŠ å…¥ (å«è‡ªå‹•åˆä½µ)
    function addPortion(itemString, portion) {
        const item = JSON.parse(decodeURIComponent(itemString));
        let plate = JSON.parse(localStorage.getItem('goutPlate_v7') || "[]");

        // 1. æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨åŒåé£Ÿç‰©
        const existingIndex = plate.findIndex(p => p.name === item.name);

        if (existingIndex !== -1) {
            // A. å·²å­˜åœ¨ï¼šæ›´æ–°è©²é …ç›®çš„ä»½é‡èˆ‡æ™®æ—
            let existingItem = plate[existingIndex];
            
            // æ›´æ–°ä»½é‡ (ä¾‹å¦‚åŸæœ¬ 0.5ï¼Œå†åŠ  0.5 è®Šæˆ 1.0)
            existingItem.portion = (existingItem.portion || 1) + portion;
            
            // é‡æ–°è¨ˆç®—ç¸½æ™®æ— (åŸºæ•¸ * æ–°ä»½é‡)
            // é€™è£¡å‡è¨­ item.purine æ˜¯ 100g çš„åŸºæº–å€¼
            // ä½†å› ç‚º item æ˜¯å¾åˆ—è¡¨é»æ“Šä¾†çš„ï¼Œå®ƒçš„ purine å°±æ˜¯åŸºæº–å€¼
            // æˆ‘å€‘éœ€è¦ç¢ºä¿ plate è£¡å­˜çš„è³‡æ–™çµæ§‹æ­£ç¢º
            
            // ç‚ºäº†ç²¾ç¢ºï¼Œæˆ‘å€‘æ¯æ¬¡éƒ½ç”¨åŸå§‹åŸºæº–å€¼ (item.purine) ä¾†é‡ç®—ç¸½æ™®æ—
            existingItem.purine = item.purine * existingItem.portion;
            
            plate[existingIndex] = existingItem;
        } else {
            // B. ä¸å­˜åœ¨ï¼šæ–°å¢ä¸€ç­†
            // è¤‡è£½ç‰©ä»¶ä¸¦åŠ å…¥ portion å±¬æ€§
            const newItem = {
                ...item,
                portion: portion,
                purine: item.purine * portion // åˆå§‹æ™®æ— = åŸºæº– * ä»½é‡
            };
            plate.push(newItem);
        }

        localStorage.setItem('goutPlate_v7', JSON.stringify(plate));
        renderPlate();
        
        const portionMsg = portion === 0.5 ? "åŠä»½" : "å…¨ä»½";
        showToast(`å·²åŠ å…¥ ${item.name} (${portionMsg})`);
    }

    function removeFromPlate(index) {
        let plate = JSON.parse(localStorage.getItem('goutPlate_v7') || "[]");
        plate.splice(index, 1);
        localStorage.setItem('goutPlate_v7', JSON.stringify(plate));
        renderPlate();
    }

    function clearPlate() {
        if(confirm("ç¢ºå®šè¦é‡ç½®è¨ˆç®—å—ï¼Ÿ")) {
            localStorage.setItem('goutPlate_v7', "[]");
            renderPlate();
        }
    }

    function renderPlate() {
        const plate = JSON.parse(localStorage.getItem('goutPlate_v7') || "[]");
        renderPlateList(plate.slice().reverse());
        
        let total = 0;
        const hasTrigger = plate.some(item => item.isTrigger === true);

        plate.forEach(i => total += (i.purine || 0));
        
        const totalDisplay = document.getElementById('totalPurine');
        const progressFill = document.getElementById('progressFill');
        const statusText = document.getElementById('statusText');
        
        animateValue(totalDisplay, parseInt(totalDisplay.innerText), total, 500);

        let percentage = (total / 400) * 100;
        if(percentage > 100) percentage = 100;
        
        progressFill.style.width = percentage + "%";
        
        if (hasTrigger) {
            progressFill.style.backgroundColor = "var(--danger)";
            progressFill.style.opacity = "0.8";
            statusText.innerHTML = "ğŸš¨ <b>ä»£è¬å—é˜»è­¦å ±ï¼</b><br>å«é…’ç²¾/é«˜ç³–ï¼Œé˜»ç¤™å°¿é…¸æ’å‡º";
            statusText.style.color = "var(--danger)";
        } else {
            progressFill.style.opacity = "1";
            if (total < 200) {
                progressFill.style.backgroundColor = "var(--safe)";
                statusText.innerText = "âœ… é€™ä¸€é¤å¾ˆå®‰å…¨ (å–®é¤å»ºè­° <200)";
                statusText.style.color = "var(--safe)";
            } else if (total < 300) {
                progressFill.style.backgroundColor = "var(--warn)";
                statusText.innerText = "âš ï¸ ç•™æ„ä»½é‡ (å…¨æ—¥å»ºè­° <400)";
                statusText.style.color = "#FFCC00";
            } else {
                progressFill.style.backgroundColor = "var(--danger)";
                statusText.innerText = "ğŸš¨ å±éšªï¼æ¥è¿‘å–®æ—¥ä¸Šé™";
                statusText.style.color = "var(--danger)";
            }
        }
    }

    function animateValue(obj, start, end, duration) {
        if (start === end) return;
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            obj.innerHTML = Math.floor(progress * (end - start) + start);
            if (progress < 1) {
                window.requestAnimationFrame(step);
            }
        };
        window.requestAnimationFrame(step);
    }

    // è‡ªè¨‚é£Ÿç‰©
    function openCustomModal() { document.getElementById('customModal').style.display = 'flex'; }
    function closeCustomModal() { document.getElementById('customModal').style.display = 'none'; }
    
    function saveNewFood() {
        const name = document.getElementById('newFoodName').value;
        const purine = parseInt(document.getElementById('newFoodPurine').value) || 0;
        const level = parseInt(document.getElementById('newFoodLevel').value);
        
        if(!name) { alert("è«‹è¼¸å…¥åç¨±"); return; }
        
        const newFood = { name, purine, level, isCustom:true, tags: ["è‡ªè¨‚"] };
        let customFoods = JSON.parse(localStorage.getItem('myGoutFoods_v7') || "[]");
        customFoods.unshift(newFood);
        localStorage.setItem('myGoutFoods_v7', JSON.stringify(customFoods));
        closeCustomModal();
        init();
    }
    
    function showToast(msg) {
        const t = document.getElementById("toast");
        t.innerText = msg; t.className = "show";
        setTimeout(() => t.className = "", 2000);
    }

    window.onclick = function(event) {
        if (event.target.classList.contains('modal-overlay')) {
            closeCustomModal();
        }
    }

    init();
</script>
</body>
</html>
