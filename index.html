<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="ç—›é¢¨è¨ˆç®—æ©ŸPro">
<title>ç—›é¢¨è¨ˆç®—æ©Ÿ v7.1</title>
<style>
    /* CSS ä¿æŒä¸è®Šï¼Œç‚ºäº†ç¯€çœç©ºé–“ï¼Œé€™è£¡æ²¿ç”¨ v7.0 çš„æ¨£å¼ */
    :root { --safe: #34C759; --warn: #FFCC00; --danger: #FF3B30; --bg: #F2F2F7; --card: #FFFFFF; --blue: #007AFF; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg); margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; -webkit-tap-highlight-color: transparent; }
    .page-container { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 110px; display: none; }
    .page-container.active { display: block; }
    .dashboard { background: white; padding: 15px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 50; }
    .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .total-display { font-size: 20px; font-weight: 800; color: #333; }
    .limit-label { font-size: 12px; color: #888; }
    .progress-track { height: 12px; background: #E5E5EA; border-radius: 6px; overflow: hidden; position: relative; }
    .progress-fill { height: 100%; width: 0%; transition: width 0.5s, background-color 0.5s; }
    .marker-line { position: absolute; top:0; bottom:0; width: 2px; background: #fff; z-index: 2; }
    .controls { padding: 10px 15px; }
    input[type="text"] { width: 100%; padding: 12px; font-size: 16px; border: none; border-radius: 12px; background: #E5E5EA; outline: none; box-sizing: border-box; }
    .filter-group { display: flex; gap: 8px; margin-top: 10px; overflow-x: auto; padding-bottom: 5px; }
    .filter-btn { padding: 6px 12px; border-radius: 15px; border: none; font-size: 13px; font-weight: 600; cursor: pointer; opacity: 0.6; color: white; white-space: nowrap; flex-shrink: 0; }
    .filter-btn.active { opacity: 1; transform: scale(1.05); }
    #foodList, #plateList { display: grid; grid-template-columns: 1fr; gap: 10px; padding: 0 15px; }
    .food-card { background: var(--card); border-radius: 12px; padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    .food-info { display: flex; flex-direction: column; }
    .food-name { font-size: 16px; font-weight: 600; margin-bottom: 4px; }
    .food-meta { font-size: 12px; color: #666; display: flex; align-items: center; gap: 8px; }
    .badge { padding: 2px 6px; border-radius: 4px; color: white; font-weight: bold; font-size: 10px; }
    .bg-green { background-color: var(--safe); }
    .bg-yellow { background-color: var(--warn); color: black; }
    .bg-red { background-color: var(--danger); }
    .add-btn { background: #F2F2F7; color: var(--blue); border: none; padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 600; cursor: pointer; }
    .add-btn:active { background: #d1d1d6; }
    .remove-btn { color: var(--danger); background: none; border: 1px solid var(--danger); padding: 4px 10px; border-radius: 6px; font-size: 12px; }
    .bottom-nav { position: fixed; bottom: 0; width: 100%; background: rgba(255,255,255,0.95); border-top: 1px solid #ddd; display: flex; justify-content: space-around; padding: 10px 0; backdrop-filter: blur(10px); z-index: 100; padding-bottom: max(10px, env(safe-area-inset-bottom)); }
    .nav-item { display: flex; flex-direction: column; align-items: center; color: #8E8E93; font-size: 10px; border: none; background: none; cursor: pointer; width: 50%; }
    .nav-item.active { color: var(--blue); }
    .nav-icon { font-size: 24px; margin-bottom: 2px; }
    #toast { visibility: hidden; min-width: 200px; background-color: #333; color: #fff; text-align: center; border-radius: 50px; padding: 10px; position: fixed; z-index: 300; left: 50%; bottom: 90px; transform: translateX(-50%); font-size: 14px; opacity: 0; transition: opacity 0.3s; }
    #toast.show { visibility: visible; opacity: 0.9; bottom: 100px; }
    .fab { position: fixed; bottom: 100px; right: 20px; background: var(--blue); color: white; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; border: none; box-shadow: 0 4px 10px rgba(0,122,255,0.3); z-index: 90; }
    .clear-btn { font-size: 13px; color: #888; border: 1px solid #ddd; padding: 4px 8px; border-radius: 6px; background: none; cursor: pointer; }
</style>
</head>
<body>

    <div class="dashboard">
        <div class="dashboard-header">
            <div>
                <div class="limit-label">æœ¬é¤æ”å– (ç›®æ¨™: <150mg)</div>
                <div class="total-display"><span id="totalPurine">0</span> <span style="font-size:14px; color:#666;">mg</span></div>
            </div>
            <button class="clear-btn" onclick="clearPlate()">ğŸ—‘ï¸ é‡ç½®</button>
        </div>
        <div class="progress-track">
            <div id="progressFill" class="progress-fill" style="width: 0%;"></div>
            <div class="marker-line" style="left: 37.5%;"></div> 
        </div>
        <div style="display:flex; justify-content:space-between; margin-top:4px; font-size:10px; color:#999;">
            <span>0</span>
            <span style="margin-left:-10px;">150 (å–®é¤)</span>
            <span>400 (å…¨æ—¥)</span>
        </div>
        <div id="statusText" style="text-align:center; margin-top:8px; font-size:13px; font-weight:bold; color:var(--safe);">âœ… å®‰å…¨ç¯„åœ</div>
    </div>

    <div id="searchPage" class="page-container active">
        <div class="controls">
            <input type="text" id="searchInput" placeholder="æœå°‹é£Ÿç‰© (ä¾‹: èœå¿ƒ, è˜‹æœ)..." onkeyup="filterFood()">
            <div class="filter-btn-group">
                <button class="filter-btn bg-green" onclick="filterByColor('green')">ğŸŸ¢ æ”¾å¿ƒ</button>
                <button class="filter-btn bg-yellow" onclick="filterByColor('yellow')">ğŸŸ¡ é©é‡</button>
                <button class="filter-btn bg-red" onclick="filterByColor('red')">ğŸ”´ å°å¿ƒ</button>
                <button class="filter-btn" style="background:#8E8E93" onclick="filterByColor('all')">å…¨éƒ¨</button>
            </div>
        </div>
        <div id="foodList"></div>
    </div>

    <div id="platePage" class="page-container">
        <h2 style="padding:0 20px; font-size:18px;">å·²é¸é£Ÿç‰©æ¸…å–®</h2>
        <div id="plateList"></div>
    </div>

    <button class="fab" onclick="openCustomModal()">+</button>

    <nav class="bottom-nav">
        <button class="nav-item active" onclick="switchTab('search')" id="tab-search">
            <div class="nav-icon">ğŸ”</div>
            <div>æ‰¾é£Ÿç‰©</div>
        </button>
        <button class="nav-item" onclick="switchTab('plate')" id="tab-plate">
            <div class="nav-icon">ğŸ½ï¸</div>
            <div>çœ‹é¤ç›¤</div>
        </button>
    </nav>

    <div id="toast">å·²åŠ å…¥ï¼</div>
    
    <div id="customModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); z-index:200; align-items:center; justify-content:center;">
        <div style="background:white; padding:20px; border-radius:20px; width:80%; max-width:300px;">
            <h3 style="margin-top:0;">æ–°å¢è‡ªè¨‚é£Ÿç‰©</h3>
            <input type="text" id="newFoodName" placeholder="åç¨±" style="width:100%; padding:10px; margin-bottom:10px; box-sizing:border-box;">
            <input type="number" id="newFoodPurine" placeholder="æ™®æ—å€¼ (mg/100g)" style="width:100%; padding:10px; margin-bottom:10px; box-sizing:border-box;">
            <select id="newFoodLevel" style="width:100%; padding:10px; margin-bottom:20px;">
                <option value="0">ğŸŸ¢ ç¶ ç‡ˆ</option>
                <option value="1">ğŸŸ¡ é»ƒç‡ˆ</option>
                <option value="2">ğŸ”´ ç´…ç‡ˆ</option>
            </select>
            <div style="display:flex; gap:10px;">
                <button onclick="closeCustomModal()" style="flex:1; padding:10px;">å–æ¶ˆ</button>
                <button onclick="saveNewFood()" style="flex:1; padding:10px; background:var(--blue); color:white; border:none;">å„²å­˜</button>
            </div>
        </div>
    </div>

<script>
    // ğŸŒŸ v7.1 æ“´å……æ•¸æ“šåº« (å¹³è¡¡ç´…ç¶ ç‡ˆæ¯”ä¾‹)
    const defaultDB = [
        // --- ğŸŸ¢ æ–°å¢æ“´å……ï¼šç¶ ç‡ˆè»åœ˜ (è®“åˆ—è¡¨æ›´å¹³è¡¡) ---
        {name: "èœå¿ƒ/èŠ¥è˜­", purine: 25, level: 0},
        {name: "é’ç“œ/é’ç“œ", purine: 10, level: 0},
        {name: "èŒ„å­", purine: 20, level: 0},
        {name: "ç²Ÿç±³ (Corn)", purine: 30, level: 0},
        {name: "å—ç“œ", purine: 25, level: 0},
        {name: "ç”˜ç­/ç´…è˜¿è””", purine: 15, level: 0},
        {name: "é›²è€³/æœ¨è€³", purine: 10, level: 0},
        {name: "é‡‘é‡è‡", purine: 50, level: 0},
        {name: "ç•ªèŒ„è›‹é£¯", purine: 50, level: 0},
        {name: "ç±³ç²‰/ç²‰çµ²", purine: 15, level: 0},
        {name: "é€šç²‰/æ„ç²‰", purine: 20, level: 0},
        {name: "æ–¹åŒ…/é¥…é ­", purine: 20, level: 0},
        {name: "è˜‹æœ", purine: 14, level: 0},
        {name: "é¦™è•‰", purine: 16, level: 0},
        {name: "ç«é¾æœ", purine: 20, level: 0},
        {name: "è¥¿ç“œ", purine: 10, level: 0},
        {name: "è—è“/å£«å¤šå•¤æ¢¨", purine: 18, level: 0},
        {name: "å¸ƒç”¸/å•«å–±", purine: 8, level: 0},

        // --- ğŸŸ¡ æ–°å¢æ“´å……ï¼šé»ƒç‡ˆå€ ---
        {name: "çš®è›‹ç˜¦è‚‰ç²¥", purine: 70, level: 1},
        {name: "ç²Ÿç±³è‚‰ç²’é£¯", purine: 80, level: 1},
        {name: "æä»/æ ¸æ¡ƒ", purine: 35, level: 1},
        {name: "èŠ±ç”Ÿ", purine: 79, level: 1},

        // --- åŸæœ‰è³‡æ–™ (ä¿ç•™é‡è¦åœ°é›·èˆ‡è¨­å®š) ---
        // ç¦å¿Œç‹è€…
        {name: "é›ç²¾/æ»´é›ç²¾", purine: 500, level: 2}, 
        {name: "å°é­šä¹¾", purine: 1138, level: 2},     
        {name: "é…µæ¯ç²‰", purine: 680, level: 2},
        {name: "è±¬è‚", purine: 284, level: 2},
        {name: "å¤§é–˜èŸ¹è†", purine: 300, level: 2},    
        {name: "è€ç«æ¹¯", purine: 150, level: 2},      
        {name: "å•¤é…’ (350ml)", purine: 20, level: 2}, 

        // è‚‰é¡
        {name: "è¥¿å†·/è‚‰çœ¼ç‰›æ’", purine: 110, level: 2}, 
        {name: "ç‰›è…©", purine: 130, level: 2},
        {name: "å‰åˆ—ç‰›/è±¬ (ç‚¸)", purine: 120, level: 2}, 
        {name: "é›è…¿è‚‰", purine: 140, level: 2},
        {name: "ç‡’éµ/é´¨", purine: 165, level: 2},
        {name: "ç˜¦è±¬è‚‰", purine: 119, level: 1},
        {name: "é›èƒ¸è‚‰", purine: 137, level: 1},      
        {name: "Parma Ham", purine: 150, level: 2},   

        // æµ·é®®
        {name: "æ²™ç”¸é­š", purine: 210, level: 2},
        {name: "é¯–é­š", purine: 165, level: 2},
        {name: "è ”/é’å£", purine: 180, level: 2},
        {name: "é­šå­é†¬", purine: 144, level: 2},      
        {name: "ä¸‰æ–‡é­š", purine: 119, level: 1},
        {name: "é±ˆé­š", purine: 109, level: 1},
        {name: "æµ·åƒ", purine: 8, level: 0},          
        {name: "ä¸‰æ–‡é­šç±½", purine: 20, level: 0},     

        // é»å¿ƒ/åŠ å·¥
        {name: "å°ç± åŒ…", purine: 100, level: 2},      
        {name: "é³³çˆª", purine: 130, level: 2},
        {name: "è±¬æ½¤éºµ", purine: 280, level: 2},
        {name: "è²¢ä¸¸/ç‰›ä¸¸", purine: 80, level: 2},    
        {name: "èŒ¶ç¢—è’¸", purine: 20, level: 0},       

        // è”¬æœè±† (åŸæœ‰)
        {name: "ä¹¾é»ƒè±†", purine: 172, level: 2},
        {name: "è¥¿è˜­èŠ±", purine: 70, level: 0},       
        {name: "è èœ", purine: 57, level: 0},
        {name: "è˜†ç­", purine: 55, level: 1},
        {name: "é®®å†¬è‡", purine: 60, level: 1},
        {name: "è±†è…", purine: 20, level: 0},         
        {name: "ç™½é£¯/éºµ", purine: 25, level: 0},
        {name: "é›è›‹", purine: 0, level: 0},          
        {name: "ç‰›å¥¶", purine: 0, level: 0},

        // å…¶ä»–
        {name: "å†¬è”­åŠŸæ¹¯", purine: 180, level: 2},    
        {name: "è±šéª¨æ‹‰éºµæ¹¯", purine: 160, level: 2},
        {name: "çç å¥¶èŒ¶", purine: 10, level: 2},     
    ];

    let allFoods = [];
    let currentFilter = 'all';

    function init() {
        allFoods = [...defaultDB];
        // ä¾ç…§ level æ’åºï¼Œè®“ç¶ ç‡ˆ(0)åœ¨å‰é¢ï¼Œçœ‹èµ·ä¾†å¿ƒæƒ…æ¯”è¼ƒå¥½
        allFoods.sort((a, b) => a.level - b.level);
        
        const customData = localStorage.getItem('myGoutFoods_v7');
        if (customData) {
            const customFoods = JSON.parse(customData);
            customFoods.forEach(f => f.isCustom = true);
            allFoods = [...customFoods, ...allFoods];
        }
        filterFood();
        renderPlate();
    }

    function switchTab(tab) {
        document.querySelectorAll('.page-container').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById(tab + 'Page').classList.add('active');
        document.getElementById('tab-' + tab).classList.add('active');
    }

    function renderList(items) {
        const listContainer = document.getElementById('foodList');
        listContainer.innerHTML = '';
        if (items.length === 0) {
            listContainer.innerHTML = '<div style="text-align:center;color:#999;padding:20px;">æ‰¾ä¸åˆ°...</div>';
            return;
        }
        items.forEach(item => {
            const div = document.createElement('div');
            div.className = 'food-card';
            let badgeClass = '', badgeText = '';
            if(item.level == 0) { badgeClass = 'bg-green'; badgeText = 'ç¶ '; }
            else if(item.level == 1) { badgeClass = 'bg-yellow'; badgeText = 'é»ƒ'; }
            else { badgeClass = 'bg-red'; badgeText = 'ç´…'; }
            const itemString = encodeURIComponent(JSON.stringify(item));
            div.innerHTML = `
                <div class="food-info">
                    <span class="food-name">${item.name} ${item.isCustom ? 'âœï¸':''}</span>
                    <div class="food-meta">
                        <span class="badge ${badgeClass}">${badgeText}</span>
                        <span>ç´„ ${item.purine} mg/100g</span>
                    </div>
                </div>
                <button class="add-btn" onclick="addToPlate('${itemString}')">åŠ å…¥</button>
            `;
            listContainer.appendChild(div);
        });
    }

    function renderPlateList(items) {
        const listContainer = document.getElementById('plateList');
        listContainer.innerHTML = '';
        if (items.length === 0) {
            listContainer.innerHTML = '<div style="text-align:center;color:#999;padding:20px;">ç›¤å­ç©ºç©ºçš„...</div>';
            return;
        }
        items.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'food-card';
            const realIndex = items.length - 1 - index;
            div.innerHTML = `
                <div class="food-info">
                    <span class="food-name">${item.name}</span>
                    <div class="food-meta">
                        <span>+ ${item.purine} mg</span>
                    </div>
                </div>
                <button class="remove-btn" onclick="removeFromPlate(${realIndex})">ç§»é™¤</button>
            `;
            listContainer.appendChild(div);
        });
    }

    function filterFood() {
        const searchText = document.getElementById('searchInput').value.toLowerCase();
        const filtered = allFoods.filter(item => {
            const matchesSearch = item.name.toLowerCase().includes(searchText);
            const matchesColor = currentFilter === 'all' ? true :
                currentFilter === 'green' ? item.level == 0 :
                currentFilter === 'yellow' ? item.level == 1 : item.level == 2;
            return matchesSearch && matchesColor;
        });
        renderList(filtered);
    }

    function filterByColor(color) {
        currentFilter = color;
        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        filterFood();
    }

    function addToPlate(itemString) {
        const item = JSON.parse(decodeURIComponent(itemString));
        let plate = JSON.parse(localStorage.getItem('goutPlate_v7') || "[]");
        plate.push(item);
        localStorage.setItem('goutPlate_v7', JSON.stringify(plate));
        renderPlate();
        showToast(`å·²åŠ å…¥ ${item.name}`);
    }

    function removeFromPlate(index) {
        let plate = JSON.parse(localStorage.getItem('goutPlate_v7') || "[]");
        plate.splice(index, 1);
        localStorage.setItem('goutPlate_v7', JSON.stringify(plate));
        renderPlate();
    }

    function clearPlate() {
        if(confirm("é‡ç½®è¨ˆç®—ï¼Ÿ")) {
            localStorage.setItem('goutPlate_v7', "[]");
            renderPlate();
        }
    }

    function renderPlate() {
        const plate = JSON.parse(localStorage.getItem('goutPlate_v7') || "[]");
        renderPlateList(plate.slice().reverse());
        let total = 0;
        plate.forEach(i => total += (i.purine || 0));
        
        const totalDisplay = document.getElementById('totalPurine');
        const progressFill = document.getElementById('progressFill');
        const statusText = document.getElementById('statusText');
        
        animateValue(totalDisplay, parseInt(totalDisplay.innerText), total, 500);

        let percentage = (total / 400) * 100;
        if(percentage > 100) percentage = 100;
        progressFill.style.width = percentage + "%";
        
        if (total < 150) {
            progressFill.style.backgroundColor = "var(--safe)";
            statusText.innerText = "âœ… é€™ä¸€é¤å¾ˆå®‰å…¨ (å–®é¤å»ºè­° <150)";
            statusText.style.color = "var(--safe)";
        } else if (total < 300) {
            progressFill.style.backgroundColor = "var(--warn)";
            statusText.innerText = "âš ï¸ ç•™æ„ä»½é‡ (å…¨æ—¥å»ºè­° <400)";
            statusText.style.color = "#FFCC00";
        } else {
            progressFill.style.backgroundColor = "var(--danger)";
            statusText.innerText = "ğŸš¨ å±éšªï¼æ¥è¿‘å–®æ—¥ä¸Šé™";
            statusText.style.color = "var(--danger)";
        }
    }

    function animateValue(obj, start, end, duration) {
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            obj.innerHTML = Math.floor(progress * (end - start) + start);
            if (progress < 1) {
                window.requestAnimationFrame(step);
            }
        };
        window.requestAnimationFrame(step);
    }

    function openCustomModal() { document.getElementById('customModal').style.display = 'flex'; }
    function closeCustomModal() { document.getElementById('customModal').style.display = 'none'; }
    function saveNewFood() {
        const name = document.getElementById('newFoodName').value;
        const purine = parseInt(document.getElementById('newFoodPurine').value) || 0;
        const level = parseInt(document.getElementById('newFoodLevel').value);
        if(!name) return;
        
        const newFood = { name, purine, level, isCustom:true };
        let customFoods = JSON.parse(localStorage.getItem('myGoutFoods_v7') || "[]");
        customFoods.unshift(newFood);
        localStorage.setItem('myGoutFoods_v7', JSON.stringify(customFoods));
        closeCustomModal();
        init();
    }
    
    function showToast(msg) {
        const t = document.getElementById("toast");
        t.innerText = msg; t.className = "show";
        setTimeout(() => t.className = "", 2000);
    }

    init();
</script>
</body>
</html>
